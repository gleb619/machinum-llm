<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<body>
<!-- Layout -->
<div th:fragment="div" th:remove="tag">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
        <!-- Config Inputs Collapsible -->
        <div class="lg:col-span-3">
            <button @click="glossaryConfigTabs.showConfigInputs = !glossaryConfigTabs.showConfigInputs"
                    class="flex items-center justify-between w-full px-4 py-2 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors duration-200">
                <h4 class="font-medium text-gray-900 text-sm">Search Settings</h4>
                <svg :class="glossaryConfigTabs.showConfigInputs ? 'transform rotate-180' : ''"
                     class="w-5 h-5 text-gray-500 transition-transform duration-200" fill="none"
                     stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M19 9l-7 7-7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                </svg>
            </button>
            <div class="mt-4" x-show="glossaryConfigTabs.showConfigInputs">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 grid grid-cols-2 gap-2 text-xs">
                        <div>
                            <label class="block font-medium text-gray-700">Chapter Start</label>
                            <input @change="changeValue('glossaryConfigTabs', glossaryConfigTabs)"
                                   @input.debounce.300ms="fetchRelatedGlossaryItems(glossary)"
                                   class="mt-1 block w-full border border-gray-300 rounded shadow-sm py-1 px-2 focus:ring-indigo-500 focus:border-indigo-500"
                                   type="number" x-model="glossaryConfigTabs.chapterStart">
                            <div class="flex gap-1 mt-1">
                                <button
                                        @click="glossaryConfigTabs.chapterStart = 1; fetchRelatedGlossaryItems(glossary)"
                                        class="px-1.5 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 rounded text-blue-400">
                                    1
                                </button>
                                <button
                                        @click="glossaryConfigTabs.chapterStart = parseInt(glossaryConfigTabs.chapterStart) - 1; fetchRelatedGlossaryItems(glossary)"
                                        class="px-1.5 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 rounded">-
                                </button>
                                <button :disabled="glossaryConfigTabs.chapterStart <= 1"
                                        @click="glossaryConfigTabs.chapterStart = Math.round(parseInt(glossaryConfigTabs.chapterStart) / 2); fetchRelatedGlossaryItems(glossary)"
                                        class="px-1.5 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 rounded">âˆš2
                                </button>
                                <button
                                        @click="glossaryConfigTabs.chapterStart = parseInt(glossaryConfigTabs.chapterStart) + 1; fetchRelatedGlossaryItems(glossary)"
                                        class="px-1.5 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 rounded">+
                                </button>
                                <button
                                        @click="glossaryConfigTabs.chapterStart = parseInt(glossaryConfigTabs.chapterEnd) - 1; fetchRelatedGlossaryItems(glossary)"
                                        class="px-1.5 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 rounded"
                                        x-text="glossaryConfigTabs.chapterEnd - 1">100
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block font-medium text-gray-700">Chapter End</label>
                            <input @change="changeValue('glossaryConfigTabs', glossaryConfigTabs)"
                                   @input.debounce.300ms="fetchRelatedGlossaryItems(glossary)"
                                   class="mt-1 block w-full border border-gray-300 rounded shadow-sm py-1 px-2 focus:ring-indigo-500 focus:border-indigo-500"
                                   type="number" x-model="glossaryConfigTabs.chapterEnd">
                            <div class="flex gap-1 mt-1">
                                <button
                                        @click="glossaryConfigTabs.chapterEnd = glossary.chapterNumber; fetchRelatedGlossaryItems(glossary)"
                                        class="px-1.5 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 rounded text-blue-400"
                                        x-text="glossary.chapterNumber">1
                                </button>
                                <button
                                        @click="glossaryConfigTabs.chapterEnd = parseInt(glossaryConfigTabs.chapterEnd) - 1; fetchRelatedGlossaryItems(glossary)"
                                        class="px-1.5 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 rounded">-
                                </button>
                                <button :disabled="glossaryConfigTabs.chapterEnd <= 1"
                                        @click="glossaryConfigTabs.chapterEnd = Math.round(parseInt(glossaryConfigTabs.chapterEnd) * 2); fetchRelatedGlossaryItems(glossary)"
                                        class="px-1.5 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 rounded">^2
                                </button>
                                <button
                                        @click="glossaryConfigTabs.chapterEnd = parseInt(glossaryConfigTabs.chapterEnd) + 1; fetchRelatedGlossaryItems(glossary)"
                                        class="px-1.5 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 rounded">+
                                </button>
                                <button
                                        @click="glossaryConfigTabs.chapterEnd += Math.round(parseInt(glossaryConfigTabs.chapterEnd) * 0.1); fetchRelatedGlossaryItems(glossary)"
                                        class="px-1.5 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 rounded"
                                        x-text="parseInt(glossaryConfigTabs.chapterEnd) + Math.round(glossaryConfigTabs.chapterEnd * 0.1)">
                                    100
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block font-medium text-gray-700">Top K</label>
                            <input @change="changeValue('glossaryConfigTabs', glossaryConfigTabs)"
                                   @input.debounce.300ms="fetchRelatedGlossaryItems(glossary)"
                                   class="mt-1 block w-full border border-gray-300 rounded shadow-sm py-1 px-2 focus:ring-indigo-500 focus:border-indigo-500"
                                   type="number" x-model="glossaryConfigTabs.topK">
                            <div class="flex gap-1 mt-1">
                                <button @click="glossaryConfigTabs.topK = 5; fetchRelatedGlossaryItems(glossary)"
                                        class="px-1.5 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 rounded text-blue-400">
                                    5
                                </button>
                                <button @click="glossaryConfigTabs.topK = 10; fetchRelatedGlossaryItems(glossary)"
                                        class="px-1.5 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 rounded">10
                                </button>
                                <button @click="glossaryConfigTabs.topK = 20; fetchRelatedGlossaryItems(glossary)"
                                        class="px-1.5 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 rounded">20
                                </button>
                                <button @click="glossaryConfigTabs.topK = 50; fetchRelatedGlossaryItems(glossary)"
                                        class="px-1.5 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 rounded">50
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block font-medium text-gray-700">Min Score</label>
                            <input @change="changeValue('glossaryConfigTabs', glossaryConfigTabs)"
                                   @input.debounce.300ms="fetchRelatedGlossaryItems(glossary)"
                                   class="mt-1 block w-full border border-gray-300 rounded shadow-sm py-1 px-2 focus:ring-indigo-500 focus:border-indigo-500"
                                   step="0.01" type="number" x-model="glossaryConfigTabs.minScore">
                            <div class="flex gap-1 mt-1">
                                <button
                                        @click="glossaryConfigTabs.minScore = 0.1; fetchRelatedGlossaryItems(glossary)"
                                        class="px-1.5 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 rounded text-blue-400">
                                    0.1
                                </button>
                                <button
                                        @click="glossaryConfigTabs.minScore = 0.3; fetchRelatedGlossaryItems(glossary)"
                                        class="px-1.5 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 rounded">0.3
                                </button>
                                <button
                                        @click="glossaryConfigTabs.minScore = 0.5; fetchRelatedGlossaryItems(glossary)"
                                        class="px-1.5 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 rounded">0.5
                                </button>
                                <button
                                        @click="glossaryConfigTabs.minScore = 0.7; fetchRelatedGlossaryItems(glossary)"
                                        class="px-1.5 py-0.5 text-xs bg-gray-100 hover:bg-gray-200 rounded">0.7
                                </button>
                            </div>
                        </div>
                        <div class="col-span-2 pt-4 border-t border-gray-200">
                            <button @click="resetGlossaryConfig()"
                                    class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Reset Configuration
                            </button>
                        </div>

                    </div>
                    <div>
                        <h4 class="font-medium text-gray-900 text-sm">Configuration</h4>
                        <p class="mt-1 text-xs text-gray-600">Configure search parameters for related items. Adjust
                            chapter range, number of results (Top K), and minimum similarity score to refine search
                            accuracy.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Related Items -->
        <div class="mt-4 lg:col-span-3 space-y-4">
            <div th:remove="tag" th:replace="~{components/glossary/fuzzy-panel::div}">
                <p>
                    Here placed content of templates/components/glossary/fuzzy-panel.html page, tag
                    `th:fragment="div"`
                </p>
            </div>

            <template x-if="glossary.details.searching">
                <div class="flex justify-center items-center h-32 py-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                </div>
            </template>

            <div class="overflow-x-auto"
                 x-show="!glossary.details.searching && glossary.details?.relatedItems && glossary.details?.relatedItems?.length > 0">
                <table class="min-w-full divide-y divide-gray-200 text-xs">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider"
                            scope="col">
                            Name
                        </th>
                        <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider"
                            scope="col">
                            Translated
                        </th>
                        <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider"
                            scope="col">
                            Ch.
                        </th>
                        <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider"
                            scope="col">
                            Description
                        </th>
                        <th class="px-3 py-2 text-right font-medium text-gray-500 uppercase tracking-wider"
                            scope="col">
                            Actions
                        </th>
                    </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    <template :key="`${relatedItem.id}-${relatedItemIndex}`"
                              x-for="(relatedItem, relatedItemIndex) in glossaryFilteredRelatedItems(glossary)">
                        <tr class="hover:bg-gray-50">
                            <td class="px-3 py-2 whitespace-nowrap">
                                <div class="font-medium text-gray-900">
                                    <span class="block" x-text="relatedItem.name"></span>
                                    <span class="text-gray-500" x-text="relatedItem.category"></span>
                                </div>
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap">
                                <div :class="!relatedItem.ruName ? 'italic text-red-500' : 'text-gray-900'"
                                     class="max-w-xs truncate"
                                     x-text="relatedItem.ruName || 'No translation text'"></div>
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap">
                                <a class="text-gray-300 hover:text-blue-600"
                                   x-bind:href="`/chapters?chapterId=${relatedItem.chapterId}`"
                                   x-text="`${relatedItem.chapterNumber}`"></a>
                            </td>
                            <td class="px-3 py-2">
                                <div class="text-gray-900 max-w-xs">
                                            <span :title="relatedItem.description" class="block truncate"
                                                  x-text="relatedItem.description"></span>
                                    <span class="text-gray-300 hover:text-gray-600" title="References"
                                          x-show="relatedItem.references && relatedItem.references.length > 0"
                                          x-text="`[${relatedItem.references.join(', ')}]`"></span>
                                </div>
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap text-right">
                                <!--Menu section-->
                                <div class="inline-block text-left"
                                     x-data="{ menuOpen: false, menuLeft: 0, menuTop: 0, calculatePosition(el) { const rect = el.getBoundingClientRect(); const dropdownWidth = 192; this.menuLeft = Math.max(8, rect.right - dropdownWidth); this.menuTop = rect.bottom + 4; if (this.menuTop + 200 > window.innerHeight) this.menuTop = rect.top - 200 - 4; const maxLeft = Math.min(this.menuLeft, window.innerWidth - dropdownWidth - 8); this.menuLeft = Math.max(8, maxLeft); } }">
                                    <button @click="if (menuOpen) { menuOpen = false; } else { menuOpen = true; calculatePosition($el); }"
                                            class="text-gray-600 hover:text-gray-900 p-1 rounded-full hover:bg-gray-100">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <g transform="translate(24) rotate(90)">
                                                <rect fill="none" height="24" id="Rectangle" width="24"/>
                                                <circle cx="1" cy="1" id="Oval" r="1" stroke="#000000"
                                                        stroke-miterlimit="10" stroke-width="0.5" transform="translate(5 11)"/>
                                                <circle cx="1" cy="1" data-name="Oval" id="Oval-2" r="1"
                                                        stroke="#000000" stroke-miterlimit="10"
                                                        stroke-width="0.5" transform="translate(11 11)"/>
                                                <circle cx="1" cy="1" data-name="Oval" id="Oval-3" r="1"
                                                        stroke="#000000" stroke-miterlimit="10"
                                                        stroke-width="0.5" transform="translate(17 11)"/>
                                            </g>
                                        </svg>
                                    </button>
                                    <div @click.away="menuOpen = false" class="w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5"
                                         x-bind:style="`position: fixed; left: ${menuLeft}px; top: ${menuTop}px; z-index: 9999;`"
                                         x-show="menuOpen">
                                        <div class="py-1">
                                            <button @click="changeGlossaryName(glossary, relatedItem); menuOpen = false"
                                                    class="group flex w-full items-center px-4 py-2 text-sm text-indigo-600 hover:bg-indigo-50 hover:text-indigo-900">
                                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                    <path
                                                            d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z">
                                                    </path>
                                                </svg>
                                                Replace Name
                                            </button>
                                            <button @click="changeGlossaryTranslatedName(glossary, relatedItem); menuOpen = false"
                                                    class="group flex w-full items-center px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 hover:text-blue-900">
                                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                    <path
                                                            d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z">
                                                    </path>
                                                </svg>
                                                <span class="truncate">Replace Translated Name</span>
                                            </button>
                                            <button @click="changeGlossaryAlternativeName(glossary, relatedItem); menuOpen = false"
                                                    class="group flex w-full items-center px-4 py-2 text-sm text-orange-600 hover:bg-orange-50 hover:text-orange-900">
                                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M15.2685 11.3076C14.9169 11.0248 14.5923 10.7795 14.2848 10.5693C13.3451 9.92712 12.672 9.68977 12 9.68977C11.328 9.68977 10.6549 9.92712 9.71521 10.5693C8.75213 11.2275 7.62138 12.2301 6.02073 13.6529L3.66436 15.7474C3.25158 16.1143 2.61951 16.0771 2.25259 15.6644C1.88567 15.2516 1.92285 14.6195 2.33564 14.2526L4.74407 12.1118C6.28074 10.7458 7.50586 9.65678 8.58672 8.91809C9.70321 8.15504 10.771 7.68977 12 7.68977C13.229 7.68977 14.2968 8.15504 15.4133 8.91809C15.8434 9.21204 16.2963 9.56146 16.7827 9.96172L15.2685 11.3076Z"
                                                          fill="#000000"/>
                                                    <path d="M18.3151 13.9514L20.3356 15.7474C20.7484 16.1143 21.3805 16.0771 21.7474 15.6644C22.1143 15.2516 22.0771 14.6195 21.6644 14.2526L19.8203 12.6134L18.3151 13.9514Z"
                                                          fill="#000000"/>
                                                    <path d="M5.6224 9.99307L3.66436 8.25259C3.25158 7.88567 2.61951 7.92285 2.25259 8.33564C1.88567 8.74842 1.92285 9.38049 2.33564 9.74741L4.1172 11.331L5.6224 9.99307Z"
                                                          fill="#000000"/>
                                                    <path d="M7.15251 13.9848C7.6635 14.4075 8.13756 14.7749 8.58672 15.0819C9.70321 15.845 10.771 16.3102 12 16.3102C13.229 16.3102 14.2968 15.845 15.4133 15.0819C16.4941 14.3432 17.7193 13.2542 19.2559 11.8882L21.6644 9.74741C22.0771 9.38049 22.1143 8.74842 21.7474 8.33564C21.3805 7.92285 20.7484 7.88567 20.3356 8.25259L17.9793 10.3471C16.3786 11.7699 15.2479 12.7725 14.2848 13.4307C13.3451 14.0729 12.672 14.3102 12 14.3102C11.328 14.3102 10.6549 14.0729 9.71521 13.4307C9.38867 13.2075 9.04286 12.9448 8.66599 12.6395L7.15251 13.9848Z"
                                                          fill="#000000"/>
                                                    <path clip-rule="evenodd" d="M21.7474 8.33564C22.1143 8.74842 22.0771 9.38049 21.6644 9.74741L19.2559 11.8882C17.7193 13.2542 16.4941 14.3432 15.4133 15.0819C14.2968 15.845 13.229 16.3102 12 16.3102C10.9247 16.3102 9.97074 15.9539 8.99698 15.3497C8.52769 15.0585 8.38332 14.442 8.6745 13.9728C8.96569 13.5035 9.58218 13.3591 10.0515 13.6503C10.8187 14.1264 11.4086 14.3102 12 14.3102C12.672 14.3102 13.3451 14.0729 14.2848 13.4307C15.2479 12.7725 16.3786 11.7699 17.9793 10.3471L20.3356 8.25259C20.7484 7.88567 21.3805 7.92285 21.7474 8.33564Z"
                                                          fill="#000000"
                                                          fill-rule="evenodd"/>
                                                </svg>
                                                Set Alternative Name
                                            </button>
                                            <button @click="changeGlossaryText(glossary, relatedItem); menuOpen = false"
                                                    class="group flex w-full items-center px-4 py-2 text-sm text-green-600 hover:bg-green-50 hover:text-green-900">
                                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                    <path
                                                            d="M12 3V21M9 21H15M19 6V3H5V6"
                                                            fill="none"
                                                            stroke="currentColor" stroke-linecap="round"
                                                            stroke-linejoin="round" stroke-width="2">
                                                    </path>
                                                </svg>
                                                Replace Text
                                            </button>
                                            <button @click="changeGlossarySummary(glossary, relatedItem); menuOpen = false"
                                                    class="group flex w-full items-center px-4 py-2 text-sm text-yellow-600 hover:bg-yellow-50 hover:text-yellow-900">
                                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                    <path
                                                            d="M12 3V21M9 21H15M19 6V3H5V6"
                                                            fill="none"
                                                            stroke="currentColor" stroke-linecap="round"
                                                            stroke-linejoin="round" stroke-width="2">
                                                    </path>
                                                </svg>
                                                Replace Summary
                                            </button>
                                            <button @click="applyAllGlossaryChanges(glossary, relatedItem); menuOpen = false"
                                                    class="group flex w-full items-center px-4 py-2 text-sm text-purple-600 hover:bg-purple-50 hover:text-purple-900">
                                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                    <path
                                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                            fill="currentColor" fill-rule="evenodd">
                                                    </path>
                                                </svg>
                                                Apply All
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </template>
                    </tbody>
                </table>
            </div>
            <div class="min-w-full text-center p-8 bg-gray-50 rounded-lg"
                 x-show="!glossary.details.searching && (!glossary.details.relatedItems || glossary.details.relatedItems.length === 0)">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-linecap="round"
                          stroke-linejoin="round" stroke-width="2"></path>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No related items found</h3>
                <p class="mt-1 text-sm text-gray-500">Try adjusting search settings for broader results or fewer
                    filters.</p>
                <div class="mt-4 flex flex-wrap gap-2 justify-center">
                    <button
                            @click="glossaryConfigTabs.topK = 50; glossaryConfigTabs.minScore = 0.1; fetchRelatedGlossaryItems(glossary);"
                            class="px-3 py-2 text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-md transition">
                        More Results (50 items, 0.1 score)
                    </button>
                    <button
                            @click="glossaryConfigTabs.chapterStart = 1; glossaryConfigTabs.chapterEnd = 999999; glossaryConfigTabs.topK = 20; fetchRelatedGlossaryItems(glossary);"
                            class="px-3 py-2 text-xs bg-green-100 hover:bg-green-200 text-green-700 rounded-md transition">
                        All Chapters (20 items)
                    </button>
                    <button @click="glossary.details.filterText = ''; fetchRelatedGlossaryItems(glossary)"
                            class="px-3 py-2 text-xs bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-md transition">
                        Clear Filters
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
</body>

</html>
