<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<body>
<!-- Layout -->
<div th:fragment="div" th:remove="tag">
    <div class="lg:col-span-3">
        <button @click="glossaryConfigTabs.showSearchInputs = !glossaryConfigTabs.showSearchInputs"
                class="flex items-center justify-between w-full px-4 py-2 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors duration-200">
            <h4 class="font-medium text-gray-900 text-sm">Search</h4>
            <svg :class="glossaryConfigTabs.showSearchInputs ? 'transform rotate-180' : ''"
                 class="w-5 h-5 text-gray-500 transition-transform duration-200" fill="none" stroke="currentColor"
                 viewBox="0 0 24 24">
                <path d="M19 9l-7 7-7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
            </svg>
        </button>
        <div class="mt-4" x-show="glossaryConfigTabs.showSearchInputs">
            <div class="flex flex-col gap-4">
                <!-- Search Section -->
                <div class="space-y-2">
                    <div class="text-xs font-medium text-gray-700">Search Glossary</div>
                    <div class="flex gap-2 items-end flex-1">
                        <!-- Unified Search Input Area -->
                        <div class="flex-1 relative">
                            <!-- Search Icon (Left Side) -->
                            <div class="absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none">
                                <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor"
                                     viewBox="0 0 24 24">
                                    <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-linecap="round"
                                          stroke-linejoin="round" stroke-width="2"></path>
                                </svg>
                            </div>

                            <!-- Unified Input Element -->
                            <textarea @input.debounce.300ms="fetchRelatedGlossaryItems(glossary)"
                                      class="pl-8 pr-24 py-2 w-full text-sm border border-gray-200 rounded focus:ring-1 focus:ring-blue-400 focus:border-blue-400 h-10"
                                      placeholder="Search title..."
                                      type="text" x-model="glossary.details.searchText"
                                      x-show="glossaryConfigTabs.selectedAlgorithm !== 'fuzzy'"></textarea>

                            <textarea @input="updateFuzzyPreview(glossary);" @input.debounce.300ms="applyFuzzyFormat(glossary)"
                                      class="pl-8 pr-24 py-2 w-full text-sm border border-gray-200 rounded focus:ring-1 focus:ring-blue-400 focus:border-blue-400 resize-none overflow-hidden h-10"
                                      placeholder="Enter text for fuzzy search..."
                                      rows="1" x-model="glossary.details.fuzzyTextInput"
                                      x-show="glossaryConfigTabs.selectedAlgorithm === 'fuzzy'"></textarea>

                            <!-- Right Addons (Algorithm Tabs + Search Button) -->
                            <div class="absolute inset-y-0 right-0 flex items-center pr-1 gap-1">
                                <!-- Algorithm Tabs -->
                                <div class="flex gap-0.5">
                                    <button :class="glossaryConfigTabs.selectedAlgorithm === 'all' ? 'bg-blue-500 text-white' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'"
                                            @click="glossaryConfigTabs.selectedAlgorithm = 'all'; fetchRelatedGlossaryItems(glossary); changeValue('glossaryConfigTabs', glossaryConfigTabs)"
                                            class="px-1.5 py-0.5 text-xs rounded font-medium"
                                            title="All Algorithms">All
                                    </button>
                                    <button :class="glossaryConfigTabs.selectedAlgorithm === 'exact' ? 'bg-blue-500 text-white' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'"
                                            @click="glossaryConfigTabs.selectedAlgorithm = 'exact'; fetchRelatedGlossaryItems(glossary); changeValue('glossaryConfigTabs', glossaryConfigTabs)"
                                            class="px-1.5 py-0.5 text-xs rounded font-medium hidden sm:inline-block"
                                            title="Exact Match">Ex
                                    </button>
                                    <button :class="glossaryConfigTabs.selectedAlgorithm === 'contains' ? 'bg-blue-500 text-white' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'"
                                            @click="glossaryConfigTabs.selectedAlgorithm = 'contains'; fetchRelatedGlossaryItems(glossary); changeValue('glossaryConfigTabs', glossaryConfigTabs)"
                                            class="px-1.5 py-0.5 text-xs rounded font-medium hidden md:inline-block"
                                            title="Contains">*
                                    </button>
                                    <button :class="glossaryConfigTabs.selectedAlgorithm === 'fulltext' ? 'bg-blue-500 text-white' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'"
                                            @click="glossaryConfigTabs.selectedAlgorithm = 'fulltext'; fetchRelatedGlossaryItems(glossary); changeValue('glossaryConfigTabs', glossaryConfigTabs)"
                                            class="px-1.5 py-0.5 text-xs rounded font-medium hidden lg:inline-block"
                                            title="Fulltext">FT
                                    </button>
                                    <button :class="glossaryConfigTabs.selectedAlgorithm === 'trigram' ? 'bg-blue-500 text-white' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'"
                                            @click="glossaryConfigTabs.selectedAlgorithm = 'trigram'; fetchRelatedGlossaryItems(glossary); changeValue('glossaryConfigTabs', glossaryConfigTabs)"
                                            class="px-1.5 py-0.5 text-xs rounded font-medium hidden xl:inline-block"
                                            title="Trigram">3g
                                    </button>
                                    <button :class="glossaryConfigTabs.selectedAlgorithm === 'levenshtein' ? 'bg-blue-500 text-white' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'"
                                            @click="glossaryConfigTabs.selectedAlgorithm = 'levenshtein'; fetchRelatedGlossaryItems(glossary); changeValue('glossaryConfigTabs', glossaryConfigTabs)"
                                            class="px-1.5 py-0.5 text-xs rounded font-medium hidden xl:inline-block"
                                            title="Levenshtein">Lv
                                    </button>
                                    <button :class="glossaryConfigTabs.selectedAlgorithm === 'phonetic' ? 'bg-blue-500 text-white' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'"
                                            @click="glossaryConfigTabs.selectedAlgorithm = 'phonetic'; fetchRelatedGlossaryItems(glossary); changeValue('glossaryConfigTabs', glossaryConfigTabs)"
                                            class="px-1.5 py-0.5 text-xs rounded font-medium hidden 2xl:inline-block"
                                            title="Phonetic">Ph
                                    </button>
                                    <button :class="glossaryConfigTabs.selectedAlgorithm === 'jaro_winkler' ? 'bg-blue-500 text-white' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'"
                                            @click="glossaryConfigTabs.selectedAlgorithm = 'jaro_winkler'; fetchRelatedGlossaryItems(glossary); changeValue('glossaryConfigTabs', glossaryConfigTabs)"
                                            class="px-1.5 py-0.5 text-xs rounded font-medium hidden 2xl:inline-block"
                                            title="Jaro-Winkler">JW
                                    </button>
                                    <button :class="glossaryConfigTabs.selectedAlgorithm === 'fuzzy' ? 'bg-blue-500 text-white' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'"
                                            @click="glossaryConfigTabs.selectedAlgorithm = 'fuzzy'; toggleFuzzyMode(glossary); changeValue('glossaryConfigTabs', glossaryConfigTabs)"
                                            class="px-1.5 py-0.5 text-xs rounded font-medium"
                                            title="Fuzzy">~
                                    </button>
                                </div>
                                <!-- Search Button (always visible as addon) -->
                                <button @click="fetchRelatedGlossaryItems(glossary)"
                                        class="px-2 py-2 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded"
                                        title="Search">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-linecap="round"
                                              stroke-linejoin="round"
                                              stroke-width="2"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fuzzy Mode Configuration -->
                <div @remove-ngram.window="removeNGram(glossary, $event.detail.ngram)" class="space-y-3"
                     x-show="glossaryConfigTabs.selectedAlgorithm === 'fuzzy'"
                     x-transition>
                    <div class="text-xs font-medium text-gray-700">N-gram Search Configuration</div>

                    <!-- Compact N-gram Editor -->
                    <div class="bg-white border border-gray-200 rounded-lg p-3 space-y-3">
                        <!-- Tag Input Component -->
                        <div class="border border-blue-200 rounded-md p-2 min-h-[2.5rem]">
                            <!-- Active N-gram Tags (integrated with input field) -->
                            <div class="flex flex-wrap gap-1 items-center mb-2"
                                 x-show="glossary.details.activeNGrams && glossary.details.activeNGrams.length > 0">
                                <template :key="`ngram-${index}`"
                                          x-for="(ngram, index) in glossary.details.activeNGrams">
                                        <span
                                                class="inline-flex items-center px-2 py-1 bg-white text-blue-700 text-xs rounded border border-blue-300 shadow-sm">
                                            <span class="font-medium" x-text="ngram"></span>
                                            <button @click="removeNGram(glossary, ngram)"
                                                    class="ml-1 text-blue-500 hover:text-red-500 transition-colors">
                                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                    <path clip-rule="evenodd"
                                                          d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                                          fill-rule="evenodd"></path>
                                                </svg>
                                            </button>
                                        </span>
                                </template>
                            </div>

                            <!-- Input and Actions Row -->
                            <div class="flex gap-2 items-center">
                                <div class="flex-1 relative">
                                    <input :placeholder="glossary.details.activeNGrams && glossary.details.activeNGrams.length > 0
                                        ? 'Add more n-grams (space/comma separated) - Enter to add, Ctrl+Shift+Enter for auto'
                                        : 'Add n-grams (space/comma separated) - Enter to add, Ctrl+Shift+Enter for auto'"
                                           @keydown.enter.prevent="addCustomNGram(glossary)"
                                           class="w-full px-3 py-2 text-xs bg-white border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 pr-20"
                                           title="Press Enter to add n-grams, Ctrl+Shift+Enter for auto-generation" type="text"
                                           x-model="glossary.details.customNGramInput">

                                    <!-- Quality indicator badge -->
                                    <div class="absolute right-2 top-1/2 transform -translate-y-1/2"
                                         x-show="glossary.details.previewStats && glossary.details.previewStats.quality">
                                            <span :class="{
                                            'bg-green-100 text-green-800': glossary.details.previewStats?.quality?.level === 'Excellent',
                                            'bg-blue-100 text-blue-800': glossary.details.previewStats?.quality?.level === 'Good',
                                            'bg-yellow-100 text-yellow-800': glossary.details.previewStats?.quality?.level === 'Fair',
                                            'bg-red-100 text-red-800': glossary.details.previewStats?.quality?.level === 'Poor'
                                        }" class="px-2 py-0.5 text-xs rounded-full font-medium" x-text="glossary.details.previewStats?.quality?.level || 'None'">
                                            </span>
                                    </div>
                                </div>
                                <button :disabled="glossary.details.jobLoading"
                                        @click="addCustomNGram(glossary)"
                                        class="px-3 py-2 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-colors" title="Add n-grams">
                                    <span x-show="!glossary.details.jobLoading">Add</span>
                                    <span class="flex items-center" x-cloak x-show="glossary.details.jobLoading">
                                            <svg class="animate-spin h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                                        stroke-width="4"></circle>
                                                <path class="opacity-75" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"
                                                      fill="currentColor"></path>
                                            </svg>
                                            Adding...
                                        </span>
                                </button>
                            </div>
                        </div>

                        <!-- Minimal statistics and preview -->
                        <div class="grid grid-cols-3 gap-2 text-xs"
                             x-show="glossary.details.previewStats && glossary.details.previewStats.length != null">
                            <div class="bg-gray-50 p-2 rounded">
                                <div class="font-medium text-gray-700">Search Text</div>
                                <div :title="glossary.details.previewStats?.text" class="text-gray-600 truncate"
                                     x-text="glossary.details.previewStats?.text || 'None'">
                                </div>
                                <div class="text-gray-500 text-xs">
                                    <span x-text="glossary.details.previewStats?.length || 0"></span> chars
                                </div>
                            </div>
                            <div class="bg-gray-50 p-2 rounded">
                                <div class="font-medium text-gray-700">N-grams</div>
                                <div class="text-gray-600">
                                    <span x-text="glossary.details.previewStats?.totalNGrams || 0"></span> total,
                                    <span x-text="glossary.details.previewStats?.filteredNGrams || 0"></span> active
                                </div>
                                <div class="text-gray-500 text-xs"
                                     x-text="glossary.details.previewStats?.minLen != null && glossary.details.previewStats?.maxLen != null ? `Range: ${glossary.details.previewStats.minLen}-${glossary.details.previewStats.maxLen}` : 'Range: -'">
                                </div>
                            </div>
                            <div class="bg-gray-50 p-2 rounded">
                                <div class="font-medium text-gray-700">Prediction</div>
                                <div :class="{
                                    'text-green-700': (glossary.details.previewStats?.prediction || 0) >= 80,
                                    'text-blue-700': (glossary.details.previewStats?.prediction || 0) >= 60,
                                    'text-yellow-700': (glossary.details.previewStats?.prediction || 0) >= 40,
                                    'text-red-700': true
                                }" class="font-medium" x-text="`${glossary.details.previewStats?.prediction || 0}% accuracy`">
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                                    <div :class="{
                                        'bg-green-500': (glossary.details.previewStats?.prediction || 0) >= 80,
                                        'bg-blue-500': (glossary.details.previewStats?.prediction || 0) >= 60,
                                        'bg-yellow-500': (glossary.details.previewStats?.prediction || 0) >= 40,
                                        'bg-red-500': true
                                    }" :style="`width: ${glossary.details.previewStats?.prediction || 0}%`" class="h-1 rounded-full transition-all duration-300">
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- Warning message for filtered n-grams -->
                        <div class="bg-yellow-50 border border-yellow-200 rounded p-2"
                             x-show="glossary.details.previewStats && glossary.details.previewStats.removedCount > 0">
                            <div class="text-xs text-yellow-800">
                                <span class="font-medium">⚠️ Filtered out </span>
                                <span x-text="glossary.details.previewStats?.removedCount || 0"></span>
                                <span> suboptimal n-gram(s)</span>
                                <span
                                        x-show="glossary.details.previewStats?.removalReasons && glossary.details.previewStats?.removalReasons?.length > 0"
                                        x-text="`(${glossary.details.previewStats?.removalReasons.join(', ')})`">
                                    </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Filter Section -->
    <div class="space-y-2">
        <div class="text-xs font-medium text-gray-700">Filter Results</div>
        <div class="flex gap-2 items-end flex-1">
            <div class="flex-1 relative">
                <div class="absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none">
                    <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor"
                         viewBox="0 0 24 24">
                        <path
                                d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
                                stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                    </svg>
                </div>
                <input
                        class="pl-8 pr-2 py-1.5 w-full text-sm border border-gray-200 rounded focus:ring-1 focus:ring-blue-400 focus:border-blue-400"
                        placeholder="Filter results..." type="text" x-model="glossary.details.filterText">
            </div>
        </div>
    </div>
</div>
</body>

</html>
